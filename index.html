<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Birthday Story</title>
<style>
body { margin: 0; padding: 0; font-family: 'Arial', sans-serif; overflow-x: hidden; }
.page { width: 100vw; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; }
.hidden { display: none; }

/* Page 1 - Candle */
#introPage img { width: 250px; height: auto; }
#introText { font-size: 28px; color: #e7008a; margin-top: 20px; }

/* Page 2 - Alien */
#alienPage { background: linear-gradient(to bottom, #000011, #220033); color: #fff; position: relative; }
.alien { width: 150px; animation: floatAlien 3s ease-in-out infinite alternate; }
@keyframes floatAlien { 0% { transform: translateY(0px);} 100% { transform: translateY(-20px); } }
.alienText { font-size: 22px; margin-top: 10px; }
.birthdayHeader { font-size: 24px; margin-top: 5px; color:#ffdd00; }

/* Page 3 - Photo Slideshow */
#photoPage { background: #f0f8ff; flex-direction: column; }
.photo-box { width: 90%; height: 60vh; border-radius: 18px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.15); margin-bottom: 20px; }
.photo-box img { width: 100%; height: 100%; object-fit: cover; }

/* Page 4 - Alien Chat */
#chatPage { background: #111; color: #fff; overflow-y: auto; }
.chatMsg { background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 20px; margin: 8px 0; max-width: 80%; }
.chatUser { align-self: flex-end; background: rgba(255,255,255,0.3); }

/* Page 5 - Final Message */
#finalPage { background: linear-gradient(to top, #ffccff, #ff99cc); color: #fff; }
.finalMsg { font-size: 28px; font-weight: bold; }

/* Page 6 - Countdown */
#countdownPage { background: linear-gradient(to bottom, #ff99cc, #ff66aa); color:#fff; flex-direction: column; }
#countdown { font-size: 36px; font-weight:bold; color:#ffdd00; margin-bottom: 10px; }

/* Confetti */
canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
</style>
</head>
<body>

<!-- Page 1: Candle Blow -->
<div id="introPage" class="page">
  <img src="photos/cake_animated.gif" alt="Cake Animation">
  <h1 id="introText">Loading...</h1>
</div>

<!-- Page 2: Alien Arrival -->
<div id="alienPage" class="page hidden">
  <img src="photos/alien.png" class="alien">
  <div class="birthdayHeader" id="birthdayHeader"></div>
  <div class="alienText" id="alienText"></div>
</div>

<!-- Page 3: Photo Slideshow -->
<div id="photoPage" class="page hidden">
  <div class="photo-box"><img id="photo" src=""></div>
</div>

<!-- Page 4: Alien Chat -->
<div id="chatPage" class="page hidden">
  <div id="chatContainer" style="display:flex; flex-direction:column; width:90%; max-width:400px;"></div>
</div>

<!-- Page 5: Final Message -->
<div id="finalPage" class="page hidden">
  <div class="finalMsg" id="finalMsg"></div>
</div>

<!-- Page 6: Countdown -->
<div id="countdownPage" class="page hidden">
  <div id="countdown">00d 00h 00m 00s</div>
  <div>Until your next birthday ðŸŽ‰</div>
</div>

<!-- Confetti -->
<canvas id="confettiCanvas"></canvas>

<!-- Background music -->
<audio id="bgAudio" autoplay loop>
  <source src="audio/happy_song.mp3" type="audio/mpeg">
</audio>

<script>
// ---------------- Load data ----------------
let data;
fetch('data/data.json')
  .then(res => res.json())
  .then(d => {
    data = d;
    document.getElementById('introText').innerText = data.introMessage || "Blow the candle to start!";
    startIntro();
  })
  .catch(err => {
    console.error("Failed to load data.json", err);
    document.getElementById('introText').innerText = "Blow the candle to start!";
    startIntro();
  });

// ----------------- Compute Age -----------------
function getAge(){
  const birth = new Date(data.birthday.year, data.birthday.month-1, data.birthday.day);
  const today = new Date();
  let age = today.getFullYear() - birth.getFullYear();
  if(today < new Date(today.getFullYear(), birth.getMonth(), birth.getDate())) age--;
  return age;
}

// ----------------- Page 1: Candle Blow -----------------
async function detectBlow() {
  try {
    const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    if (ctx.state === 'suspended') await ctx.resume();

    const analyser = ctx.createAnalyser();
    const micSource = ctx.createMediaStreamSource(micStream);
    micSource.connect(analyser);
    const dataArr = new Uint8Array(analyser.frequencyBinCount);

    function checkNoise() {
      analyser.getByteFrequencyData(dataArr);
      const volume = dataArr.reduce((a,b)=>a+b,0)/dataArr.length;
      if(volume > 35){ startAlienPage(); }
      else { requestAnimationFrame(checkNoise); }
    }
    checkNoise();
  } catch(e) {
    console.warn("Microphone not available, skipping to next page.", e);
    setTimeout(startAlienPage, 4000);
  }
}

function startIntro() {
  detectBlow();
}

// ----------------- Page 2: Alien Arrival -----------------
function startAlienPage(){
  introPage.classList.add('hidden');
  alienPage.classList.remove('hidden');
  document.getElementById('birthdayHeader').innerText = `Happy Birthday ${data.name}, Age ${getAge()}!`;
  document.getElementById('alienText').innerText = data.birthdayMessage;

  setTimeout(startPhotoPage, 3000);
  alienPage.addEventListener('click', startPhotoPage);
}

// ----------------- Page 3: Photo Slideshow -----------------
let photoIndex=0;
function startPhotoPage(){
  alienPage.classList.add('hidden');
  photoPage.classList.remove('hidden');

  const photos = data.photos;
  photoEl.src = 'photos/'+photos[photoIndex];

  function nextPhoto(){
    photoIndex++;
    if(photoIndex>=photos.length){ startChatPage(); return; }
    photoEl.src = 'photos/'+photos[photoIndex];
  }

  const photoInterval = setInterval(nextPhoto, 2000);
  photoPage.addEventListener('click', ()=>{
    nextPhoto();
    clearInterval(photoInterval);
  });
}

// ----------------- Page 4: Alien Chat -----------------
function startChatPage(){
  photoPage.classList.add('hidden');
  chatPage.classList.remove('hidden');

  const chatContainer = document.getElementById('chatContainer');
  let i=0;
  const messages = data.alienMessages.concat([data.birthdayMessage]);

  function showNextMsg(){
    if(i>=messages.length){ startFinalPage(); return; }
    const msgDiv = document.createElement('div');
    msgDiv.className = 'chatMsg';
    msgDiv.innerText = messages[i];
    chatContainer.appendChild(msgDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    i++;
    setTimeout(showNextMsg, 2000);
  }
  showNextMsg();
}

// ----------------- Page 5: Final Message -----------------
function startFinalPage(){
  chatPage.classList.add('hidden');
  finalPage.classList.remove('hidden');
  document.getElementById('finalMsg').innerText = data.finalMessage;
  startConfetti();

  setTimeout(startCountdownPage, 5000);
}

// ----------------- Page 6: Countdown -----------------
function startCountdownPage(){
  finalPage.classList.add('hidden');
  countdownPage.classList.remove('hidden');

  function getNextBirthday(){
    const today = new Date();
    let year = today.getFullYear();
    let nextBD = new Date(Date.UTC(year, data.birthday.month-1, data.birthday.day, 18, 30, 0));
    if(today >= nextBD) nextBD.setUTCFullYear(year+1);
    return nextBD;
  }

  const countdownEl = document.getElementById('countdown');
  const nextBD = getNextBirthday();

  function updateCountdown(){
    const now = new Date();
    let diff = nextBD - now;
    const days = Math.floor(diff / (1000*60*60*24));
    diff %= (1000*60*60*24);
    const hrs = Math.floor(diff / (1000*60*60));
    diff %= (1000*60*60);
    const mins = Math.floor(diff / (1000*60));
    const secs = Math.floor((diff % (1000*60))/1000);
    countdownEl.innerText = `${days}d ${hrs}h ${mins}m ${secs}s`;
  }

  updateCountdown();
  setInterval(updateCountdown, 1000);
}

// ----------------- Confetti -----------------
function startConfetti(){
  const canvas=document.getElementById('confettiCanvas');
  canvas.width=window.innerWidth; canvas.height=window.innerHeight;
  const ctx=canvas.getContext('2d');
  const confetti=[];
  for(let i=0;i<150;i++){
    confetti.push({
      x:Math.random()*canvas.width,
      y:Math.random()*canvas.height,
      r:Math.random()*6+2,
      d:Math.random()*150,
      color:`hsl(${Math.random()*360},100%,50%)`
    });
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    confetti.forEach(c=>{
      ctx.fillStyle=c.color;
      ctx.beginPath();
      ctx.arc(c.x,c.y,c.r,0,2*Math.PI);
      ctx.fill();
      c.y += 2;
      if(c.y > canvas.height){ c.y=-10; c.x=Math.random()*canvas.width; }
    });
    requestAnimationFrame(draw);
  }
  draw();
}
</script>
</body>
</html>
